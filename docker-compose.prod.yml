version: '3.4'

x-environments: &environments
    MYSQL_ROOT_PASSWORD: "root"
    MYSQL_PASSWORD: "password"
    MYSQL_DATABASE: "app"
    MYSQL_USER: "user"
    NODE_ENV: "production"
    API_URL: "http://staging01.dev.ru1:8082"
    RABBITMQ_HOST: "rabbit"
    RABBITMQ_DEFAULT_USER: "local"
    RABBITMQ_DEFAULT_PASS: "local"

services:
    client:
        image: konstantinpopov/payment-page-mock-client:main
        ports:
            - target: 8080
              published: 80
        environment: *environments
    nginx:
        image: konstantinpopov/payment-page-mock-nginx:main
        volumes: &sharedStatic
            - type: bind
              source: ./assets
              target: /var/www/public/assets
            - type: bind
              source: ./uploads
              target: /var/www/public/uploads
        ports:
            - target: 80
              published: 8082
    api:
        image: konstantinpopov/payment-page-mock-api:main
        environment: *environments
        volumes: *sharedStatic
    rabbit:
        image: rabbitmq:latest
        environment: *environments
        ports:
            - 5672:5672
            - 15672:15672
    db:
        image: mysql:latest
        ports:
            - target: 3306
              published: 3306
        environment: *environments
        volumes:
            - dbdata:/var/lib/mysql
volumes:
    dbdata:
    static:
