version: '3.4'

services:
    client:
        image: konstantinpopov/payment-page-mock-client:main
        ports:
            - "${CLIENT_APP_PORT}:8080"
        environment:
            NODE_ENV: $CLIENT_APP_NODE_ENV
            VUE_APP_API_URL: $API_APP_URL

    nginx:
        image: konstantinpopov/payment-page-mock-nginx:main
        volumes: &sharedStatic
            - type: bind
              source: ./assets
              target: /var/www/public/assets
            - type: bind
              source: ./uploads
              target: /var/www/public/uploads
        ports:
            - "${API_APP_PORT}:80"

    api: &server_app
        image: konstantinpopov/payment-page-mock-api:main
        environment:
            YII_ENV: $API_APP_YII_ENV
            YII_DEBUG: $API_APP_YII_DEBUG
            API_URL: $API_APP_URL
            DISABLE_SENDING_CALLBACKS: 1
            CALLBACKS_QUEUE_NAME: $API_APP_CALLBACKS_QUEUE
            CALLBACK_URL: $API_APP_CALLBACK_URL
            CALLBACK_SECRET: $API_APP_CALLBACK_SECRET
            MYSQL_DATABASE: $MYSQL_DATABASE
            MYSQL_HOST: $MYSQL_HOST
            MYSQL_PORT: 3306
            MYSQL_USER: $MYSQL_USER
            MYSQL_PASSWORD: $MYSQL_PASSWORD
            RABBITMQ_HOST: $RABBITMQ_HOST
            RABBITMQ_DEFAULT_USER: $RABBITMQ_DEFAULT_USER
            RABBITMQ_DEFAULT_PASS: $RABBITMQ_DEFAULT_PASS
            MEMCACHED_HOST: $MEMCACHED_HOST
            MEMCACHED_PORT: $MEMCACHED_PORT
        volumes: *sharedStatic

    callbacks_queue_consumer:
        <<: *server_app
        entrypoint: ["php", "yii", "queue/listen", $API_APP_CALLBACKS_QUEUE]

    rabbit:
        image: rabbitmq:latest
        environment:
            RABBITMQ_HOST: $RABBITMQ_HOST
            RABBITMQ_DEFAULT_USER: $RABBITMQ_DEFAULT_USER
            RABBITMQ_DEFAULT_PASS: $RABBITMQ_DEFAULT_PASS

    memcached:
        image: memcached:latest

    db:
        image: mysql:latest
        ports:
            - "${MYSQL_PORT}:3306"
        environment:
            MYSQL_ROOT_PASSWORD: $MYSQL_ROOT_PASSWORD
            MYSQL_DATABASE: $MYSQL_DATABASE
            MYSQL_USER: $MYSQL_USER
            MYSQL_PASSWORD: $MYSQL_PASSWORD
        volumes:
            - dbdata:/var/lib/mysql

volumes:
    dbdata:
    static:
