version: '3.4'

services:
    client:
        build:
            context: ./src/client
            dockerfile: ../../build/images/client/Dockerfile
            target: development
        environment:
            NODE_ENV: $CLIENT_APP_NODE_ENV
            VUE_APP_API_URL: $API_APP_URL
        volumes:
            - ./src/client/src:/home/node/app/src:rw
        ports:
            - "${CLIENT_APP_PORT}:8080"

    nginx:
        build:
            context: ./src/server
            dockerfile: ../../build/images/nginx/Dockerfile
        ports:
            - "${API_APP_PORT}:80"
        volumes:
            - ./src/server/public:/var/www/public
        links:
            - api

    api: &server_app
        build:
            context: ./src/server
            dockerfile: ../../build/images/server/Dockerfile
            args:
                UID: 1000
                GID: 1000
        environment:
            PHP_IDE_CONFIG: "serverName=docker"
            YII_ENV: $API_APP_YII_ENV
            YII_DEBUG: $API_APP_YII_DEBUG
            API_URL: $API_APP_URL
            CALLBACKS_QUEUE_NAME: $API_APP_CALLBACKS_QUEUE
            CALLBACK_URL: $API_APP_CALLBACK_URL
            CALLBACK_SECRET: $API_APP_CALLBACK_SECRET
            MYSQL_DATABASE: $MYSQL_DATABASE
            MYSQL_HOST: $MYSQL_HOST
            MYSQL_PORT: 3306
            MYSQL_USER: $MYSQL_USER
            MYSQL_PASSWORD: $MYSQL_PASSWORD
            RABBITMQ_HOST: $RABBITMQ_HOST
            RABBITMQ_DEFAULT_USER: $RABBITMQ_DEFAULT_USER
            RABBITMQ_DEFAULT_PASS: $RABBITMQ_DEFAULT_PASS
            MEMCACHED_HOST: $MEMCACHED_HOST
            MEMCACHED_PORT: $MEMCACHED_PORT
        depends_on:
            - rabbit
            - memcached
        extra_hosts:
            - "host.docker.internal:host-gateway"
            - "${API_APP_CALLBACK_HOST}:${API_APP_CALLBACK_IP}"
        volumes:
            - ./src/server:/var/www:rw
        links:
            - db

    callbacks_queue_consumer:
        <<: *server_app
        restart: on-failure
        entrypoint: ["php", "yii", "queue/listen", $API_APP_CALLBACKS_QUEUE]

    rabbit:
        image: rabbitmq:latest
        environment:
            RABBITMQ_HOST: $RABBITMQ_HOST
            RABBITMQ_DEFAULT_USER: $RABBITMQ_DEFAULT_USER
            RABBITMQ_DEFAULT_PASS: $RABBITMQ_DEFAULT_PASS

    memcached:
        image: memcached:latest

    db:
        image: mysql:latest
        ports:
            - "${MYSQL_PORT}:3306"
        environment:
            MYSQL_ROOT_PASSWORD: $MYSQL_ROOT_PASSWORD
            MYSQL_DATABASE: $MYSQL_DATABASE
            MYSQL_USER: $MYSQL_USER
            MYSQL_PASSWORD: $MYSQL_PASSWORD
        volumes:
            - ./build/dump:/docker-entrypoint-initdb.d
            - dbdata:/var/lib/mysql

volumes:
    dbdata:
